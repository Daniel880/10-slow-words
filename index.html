<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Typing Trainer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #fff;
      color: #000;
    }

    .dark {
      background-color: #121212;
      color: #e0e0e0;
    }

    .word-list {
      margin-bottom: 20px;
      font-size: 3em;
    }

    .word-list span {
      margin-right: 5px;
    }

    .current {
      text-decoration: underline;
    }

    .correct {
      color: green;
    }

    .incorrect {
      color: red;
    }

    input {
      width: 100%;
      font-size: 3em;
      padding: 5px;
    }

    .results,
    .stats {
      margin-top: 20px;
    }

    .highlight {
      font-weight: bold;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f0f0f0;
    }

    .dark th,
    .dark td {
      background-color: #1e1e1e;
      color: #fff;
      border-color: #333;
    }

    .dark th {
      background-color: #2e2e2e;
    }

    .dark input {
      background-color: #1e1e1e;
      color: #fff;
      border: 1px solid #444;
    }

    button {
      margin-top: 10px;
      padding: 8px 16px;
      font-size: 1em;
    }

    .global-stats {
      display: flex;
      gap: 2em;
      font-size: 1.2em;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  <h1>Typing Trainer</h1>
  <div class="word-list" id="wordList"></div>
  <input type="text" id="input" placeholder="Start typing..." autofocus />
  <div class="stats" id="stats"></div>
  <canvas id="wpmChart" width="800" height="400"></canvas>
  <div class="results" id="results"></div>
  <button onclick="resetStats()">Reset All Stats</button>
  <button onclick="toggleTheme()">Toggle Dark Mode</button>

  <script>
    let english1k = [];
    let testWords = [];
    let startTime = null;
    let testStartTime;
    let currentIndex = 0;
    let wordStats = {};
    let history = [];
    let slowestWords = [];
    let chart;
    let slow10WPMHistory = [];

    function loadStatsFromStorage() {
      const stats = localStorage.getItem('wordStats');
      const historyData = localStorage.getItem('slow10WPMHistory');
      if (stats) {
        try { wordStats = JSON.parse(stats); } catch { }
      }
      if (historyData) {
        try { slow10WPMHistory = JSON.parse(historyData); } catch { }
      }
    }

    function saveStatsToStorage() {
      localStorage.setItem('wordStats', JSON.stringify(wordStats));
      localStorage.setItem('slow10WPMHistory', JSON.stringify(slow10WPMHistory));
    }

    function resetStats() {
      wordStats = {};
      slow10WPMHistory = [];
      saveStatsToStorage();
      startTest();
    }

    function getTestWords() {
      if (Object.keys(wordStats).length === 0) {
        return english1k.sort(() => 0.5 - Math.random()).slice(0, 20);
      }
      slowestWords = Object.entries(wordStats)
        .map(([word, stats]) => {
          const last5 = stats.last5 || [];
          const avg5 = last5.length ? last5.reduce((a, b) => a + b, 0) / last5.length : Infinity;
          return { word, avg5 };
        })
        .sort((a, b) => a.avg5 - b.avg5)
        .slice(0, 10)
        .map(e => e.word);

      const random = english1k.sort(() => 0.5 - Math.random()).slice(0, 10);
      return [...new Set([...slowestWords, ...random])].slice(0, 20);
    }

    function renderWords() {
      const container = document.getElementById("wordList");
      container.innerHTML = testWords.map((word, i) => {
        let cls = "";
        if (i === currentIndex) cls = "current";
        else if (i < currentIndex) cls = "correct";
        if (slowestWords.includes(word)) cls += " highlight"; // Highlight slowest words
        return `<span class="${cls}">${word}</span>`;
      }).join(" ");
    }

    function renderStats() {
      const statsDiv = document.getElementById("stats");
      const entries = Object.entries(wordStats).map(([word, data]) => {
        const last5 = data.last5 || [];
        const avg5 = last5.length ? last5.reduce((a, b) => a + b, 0) / last5.length : 0;
        return { word, count: last5.length, avg5, avg: data.avg, last: data.last };
      });

      const lastAvg = entries.length ? (entries.map(e => e.last).reduce((a, b) => a + b, 0) / entries.length).toFixed(1) : "-";
      const overallAvg = entries.length ? (entries.map(e => e.avg).reduce((a, b) => a + b, 0) / entries.length).toFixed(1) : "-";

      let html = `
        <div class="global-stats">
          <div><strong>LAST WPM:</strong> ${lastAvg}</div>
          <div><strong>AVG WPM:</strong> ${overallAvg}</div>
        </div>`;
      html += '<h2>Word Stats</h2><table><tr><th>#</th><th>Word</th><th>Count</th><th>Avg Last 5</th><th>Overall Avg</th><th>Last</th></tr>';
      entries
        .sort((a, b) => a.avg5 - b.avg5)
        .forEach((entry, idx) => {
          const rowClass = idx < 10 ? 'highlight' : ''; // Highlight first 10 rows
          html += `<tr class="${rowClass}">
            <td>${idx + 1}</td>
            <td>${entry.word}</td>
            <td>${entry.count}</td>
            <td>${entry.avg5.toFixed(1)}</td>
            <td>${entry.avg.toFixed(1)}</td>
            <td>${entry.last.toFixed(1)}</td>
          </tr>`;
        });
      html += '</table>';
      statsDiv.innerHTML = html;
    }

    function renderChart() {
      const avg5Line = slow10WPMHistory.map((_, i, arr) => {
        const slice = arr.slice(Math.max(0, i - 4), i + 1);
        return slice.reduce((a, b) => a + b, 0) / slice.length;
      });

      const ctx = document.getElementById("wpmChart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: slow10WPMHistory.map((_, i) => i + 1),
          datasets: [
            {
              label: 'Avg WPM of 10 Slowest Words',
              data: slow10WPMHistory,
              borderColor: 'blue',
              backgroundColor: 'blue',
              fill: false,
              tension: 0.3,
              pointRadius: 4
            },
            {
              label: 'Rolling Avg (last 5 tests)',
              data: avg5Line,
              borderColor: 'orange',
              backgroundColor: 'orange',
              fill: false,
              borderDash: [5, 5],
              tension: 0.3,
              pointRadius: 4
            }
          ]
        },
        options: {
          plugins: {
            title: {
              display: true,
              text: 'Avg WPM of 10 Slowest Words per Test'
            }
          },
          scales: {
            x: { title: { display: true, text: 'Test #' } },
            y: { title: { display: true, text: 'WPM' }, beginAtZero: true }
          }
        }
      });
    }
    function startTest() {
      testWords = getTestWords();
      currentIndex = 0;
      testStartTime = null;
      startTime = null;
      document.getElementById("input").value = "";
      history = [];
      renderWords();
      renderStats();
      renderChart();
      document.getElementById("input").focus();
    }

    function handleCorrectWord(word) {
      const now = performance.now();
      const duration = (now - startTime) / 1000 / 60;
      const wpm = 1 / duration;

      if (!wordStats[word]) wordStats[word] = { avg: wpm, last: wpm, last5: [wpm] };
      else {
        wordStats[word].avg = (wordStats[word].avg * 0.8 + wpm * 0.2);
        wordStats[word].last = wpm;
        wordStats[word].last5 = (wordStats[word].last5 || []).slice(-4).concat(wpm);
      }

      saveStatsToStorage();
      history.push({ word, wpm });
      currentIndex++;
      startTime = now;
    }

    function showResults() {
      const entries = Object.entries(wordStats).map(([word, data]) => {
        const last5 = data.last5 || [];
        const avg5 = last5.length ? last5.reduce((a, b) => a + b, 0) / last5.length : Infinity;
        return { word, avg5 };
      });
      const slow10 = entries.sort((a, b) => a.avg5 - b.avg5).slice(0, 10);
      const avgOf10 = slow10.length ? (slow10.map(e => e.avg5).reduce((a, b) => a + b, 0) / slow10.length) : 0;
      if (!isNaN(avgOf10)) {
        slow10WPMHistory.push(parseFloat(avgOf10.toFixed(1)));
        saveStatsToStorage();
      }

      const totalTimeMin = (performance.now() - testStartTime) / 1000 / 60;
      const overallWPM = testWords.length / totalTimeMin;
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = `<h2>Results</h2><p>Overall WPM: ${overallWPM.toFixed(1)}</p>`;
    }

    document.getElementById("input").addEventListener("input", function () {
      const typed = this.value.trim();
      const expected = testWords[currentIndex];
      if (!testStartTime && typed.length > 0) {
        testStartTime = performance.now();
        startTime = testStartTime;
      }

      const currentWordEl = document.querySelector(".current");
      if (expected.startsWith(typed)) {
        currentWordEl.classList.remove("incorrect");
      } else {
        currentWordEl.classList.add("incorrect");
      }

      if (typed === expected && currentIndex === testWords.length - 1) {
        handleCorrectWord(expected);
        showResults();
        startTest();
      }
    });

    document.getElementById("input").addEventListener("keydown", function (e) {
      if (e.key === " ") {
        e.preventDefault();
        const word = this.value.trim();
        const expected = testWords[currentIndex];
        if (word !== expected || currentIndex === testWords.length - 1) return;
        handleCorrectWord(expected);
        this.value = "";
        renderWords();
        renderStats();
      } else if (e.key === "Escape" || e.key === "Tab") {
        e.preventDefault();
        startTest();
      }
    });

    function toggleTheme() {
      const dark = document.body.classList.toggle("dark");
      document.cookie = `theme=${dark ? 'dark' : 'light'}; path=/; max-age=31536000`;
    }

    function loadTheme() {
      const match = document.cookie.match(/theme=(dark|light)/);
      if (match && match[1] === "dark") {
        document.body.classList.add("dark");
      }
    }

    loadTheme();

    fetch('https://raw.githubusercontent.com/SMenigat/thousand-most-common-words/master/words/en.json')
      .then(res => res.json())
      .then(data => {
        english1k = data.words.map(w => w.englishWord).filter(w => w);
        loadStatsFromStorage();
        startTest();
      });
  </script>
</body>

</html>
